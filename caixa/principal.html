<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel - Nível da Caixa d'Água</title>
  <!-- Incluir Firebase via CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    /* ... (seus estilos existentes permanecem os mesmos) ... */
:root {
      --bg: #000;
      --azul: #007bff;
      --azul-claro: #4da6ff;
      --amarelo: #facc15;
      --vermelho: #0e3c51;
      --laranja: #f48003;
      --cinza-escuro: #495057;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: var(--bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
      transition: background-color 0.5s ease;
    }
    
    body.disconnected {
      background-color: #4a0000 !important;
      animation: pulse-disconnected 2s infinite;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    
    .logo {
      margin-bottom: 15px;
      max-width: 400px;
      height: auto;
    }
    
    .header h1 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #0ff;
      text-shadow: 0 0 10px #0ff;
    }
    
    .header p {
      color: #f47006;
      text-shadow: 0 0 10px #0ff;
    }
    
    /* Contador de visitas */
    .visit-counter {     
      top: 0;
      right: 0;
      background: rgba(0, 123, 255, 0.2);
      border: 1px solid var(--azul);
      border-radius: 15px;
      padding: 8px 12px;
      font-size: 20px;
      color:#FFF ;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
      animation: pulse-green 1.5s infinite;
    }
    
    .visit-counter::before {
      content: "👁️";
      font-size: 1rem;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .visit-counter {
        position: relative;
        margin-top: 10px;
        align-self: center;
      }
    }
    
    .tank-container {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .tank-wrapper {
      position: relative;
      width: 300px;
      height: 400px;
      margin: 20px 0;
    }
    
    .tank {
      width: 100%;
      height: 100%;
      background: rgba(13, 27, 42, 0.7);
      border: 4px solid rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      position: relative;
      overflow: hidden;
    }
    
    #waterCanvas {
      width: 100%;
      height: 100%;
    }
    
    .water-level {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.5rem;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }
    
    .controls-panel {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }
    
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat .label {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 5px;
    }
    
    .stat .value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #fff;
    }
    
    .led-controls {
      margin: 25px 0;
    }
    
    .led-controls h3 {
      margin-bottom: 15px;
      color: #0ff;
      text-align: center;
    }
    
    .led-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .led-button {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
      background: #2c3e50;
      color: white;
    }
    
    .led-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .led-button.ligado {
      background: linear-gradient(to bottom, #4CAF50, #2E7D32);
      transform: scaleY(1.1);
    }
    
    .led-button.led1.ligado {
      background: linear-gradient(to bottom, #4CAF50, #2E7D32);
    }
    
    .led-button.rele.ligado {
      background: linear-gradient(to bottom, #2196F3, #0D47A1);
    }
    
    .led-button.led3.ligado {
      background: linear-gradient(to bottom, #FF9800, #E65100);
    }
    
    .led-button.led4.ligado {
      background: linear-gradient(to bottom, #9C27B0, #6A1B9A);
    }
    
    .led-button.led5.ligado {
      background: linear-gradient(to bottom, #00BCD4, #00838F);
    }
    
    .led-button.led6.ligado {
      background: linear-gradient(to bottom, #8BC34A, #558B2F);
    }
    
    .led-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #000;
      border: 2px solid #666;
      transition: all 0.3s ease;
    }
    
    .led-indicator.ligado {
      background: #22c55e;
      box-shadow: 0 0 10px #22c55e;
    }
    
    .voice-control {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
    }
    
    .voice-control h3 {
      margin-bottom: 15px;
      color: #0ff;
    }
    
    .voice-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #f48003;
      border: none;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto;
      transition: all 0.3s ease;
    }
    
    .voice-button.listening {
      background: #f44336;
      animation: pulse 1.5s infinite;
    }
    
    .voice-status {
      margin-top: 10px;
      font-size: 0.9rem;
      min-height: 20px;
    }
    
    .voice-commands {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #aaa;
    }
    
    .status-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse-green 2s infinite;
    }
    
    .status-dot.disconnected {
      background: #f44336;
      animation: none;
    }
    
    .last-update {
      font-size: 0.9rem;
      color: #aaa;
    }
    
    /* Estilos para o status da bomba */
    .pump-status {
      background: rgba(0, 0, 0, 0.3);
      padding: 5px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .pump-status h3 {
      margin-bottom: 15px;
      color: #0ff;
    }
    
    .pump-status-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .pump-indicator {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #666;
    }
    
    .pump-status.ligada {
      background-color: rgba(0, 255, 0, 0.2);
    }
    
    .pump-status.desligada {
      background-color: rgba(0, 0, 0, 0.3);
    }
    
    .pump-status.ligada .pump-indicator {
      background-color: #22c55e;
      box-shadow: 0 0 10px #22c55e;
      animation: pulse-green 1.5s infinite;
    }
    
    .pump-status.desligada .pump-indicator {
      background-color: #000;
    }
    
    /* Estilos para o texto de nível da água */
    #waterSummary {
      margin-top: 15px;
      padding: 10px 15px;
      border-radius: 8px;
      background-color: rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    #waterSummary.normal {
      background-color: rgba(0, 0, 0, 0.3);
    }
    
    #waterSummary.warning {
      background-color: rgba(202, 138, 4, 0.3);
      animation: pulse-yellow 1.5s infinite;
    }
    
    #waterSummary.danger {
      background-color: rgba(185, 28, 28, 0.3);
      animation: pulse-red 1.5s infinite;
    }
    
    /* Botão de controle de áudio */
    .audio-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .audio-toggle {
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .audio-toggle.desativado {
      background-color: #f44336;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }
    
    @keyframes pulse-green {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    @keyframes pulse-blue {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }
    
    @keyframes pulse-yellow {
      0% { transform: scale(1); background-color: rgba(202, 138, 4, 0.3); }
      50% { transform: scale(1.02); background-color: rgba(202, 138, 4, 0.6); }
      100% { transform: scale(1); background-color: rgba(202, 138, 4, 0.3); }
    }
    
    @keyframes pulse-red {
      0% { transform: scale(1); background-color: rgba(185, 28, 28, 0.3); }
      50% { transform: scale(1.02); background-color: rgba(185, 28, 28, 0.6); }
      100% { transform: scale(1); background-color: rgba(185, 28, 28, 0.3); }
    }
    
    @keyframes pulse-disconnected {
      0% { background-color: #4a0000; }
      50% { background-color: #600000; }
      100% { background-color: #4a0000; }
    }
    
    /* Novos estilos para o controle de modo e agendamento */
    .mode-control {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      margin-top: 20px;
    }
    
    .mode-control h3 {
      margin-bottom: 15px;
      color: #0ff;
      text-align: center;
    }
    
    .mode-button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }
    
    .mode-button.auto {
      background-color: var(--cinza-escuro);
      color: white;
    }
    
    .mode-button.manual {
      background-color: var(--laranja);
      color: white;
    }
    
    .scheduling {
      margin-top: 20px;
    }
    
    .scheduling h4 {
      margin-bottom: 15px;
      color: #0ff;
    }
    
    .time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .time-input {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .time-input label {
      font-size: 0.9rem;
      color: #aaa;
    }
    
    .time-input input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
      color: white;
    }
    
    .time-input input:focus {
      outline: none;
      border-color: var(--azul);
    }
    .clock {
      font-size: 60px; 
      color: #0F0; 
      background: #020024;
      text-align: center; 
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
    }
    
    .debug-panel {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .debug-title {
      color: #0ff;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .debug-log {
      color: #fff;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    /* Novos estilos para feedback visual */
    .command-feedback {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }
    
    .command-feedback.show {
      opacity: 1;
    }
    
    .voice-tutorial {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }
    
    .voice-tutorial h3 {
      color: #0ff;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .command-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .command-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    
    .command-action {
      color: #0ff;
      font-weight: bold;
    }
    
    .command-examples {
      color: #aaa;
      font-size: 0.8rem;
    }
    
    .training-button {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--laranja);
      color: white;
      border: none;
      border-radius: 8px;
      margin-top: 15px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .training-button:hover {
      background: #ff9c33;
      transform: translateY(-2px);
    }
	
	 .Agendamento {
		  font-weight: bold;
		  font-size: 1.8rem;
      color: #0ff;      
      text-align: center;
    }
	.CabecaControle {
		  font-weight: bold;
		  font-size: 1.0rem;
      color: #06f41c;      
      text-align: center;
    }
    /* Adicionar estilo para o botão de logout */
    .logout-btn {
      background: linear-gradient(to bottom, #dc3545, #c82333);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
      transition: all 0.3s ease;
      width: 100%;
    }

    .logout-btn:hover {
      background: linear-gradient(to bottom, #c82333, #bd2130);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
    }
  </style>
</head>
<body>
   <div class="container">
    <div class="header">
      <img src="img/Logo.png" alt="Logo do Sistema" class="logo">
      <h1>Sistema de Monitoramento de Caixa d'Água</h1>
      <div class="CabecaControle">Controle em tempo real via Firebase</div>
    </div>
    
    <div class="dashboard">
      <div class="tank-container">
        <h2>Nível da Água</h2>
        <div class="tank-wrapper">
          <div class="tank">
            <canvas id="waterCanvas"></canvas>
          </div>
          <div class="water-level" id="waterLevel">0%</div>
        </div>
        <div id="waterSummary" class="normal">Restante: 0 L de 445 L</div>
        <div class="audio-control">
          <span>Alerta sonoro:</span>          
          <button class="audio-toggle" id="audioToggle">Desativar</button>
        </div>
      </div>
      
      <div class="controls-panel">
        <div class="stats">
          <div class="stat">
            <div class="label">Volume</div>
            <div class="value" id="volume">0 L</div>
          </div>
          <div class="stat">
            <div class="label">Nível</div>
            <div class="value" id="level">0%</div>
          </div>
        </div>
        
        <!-- Novo controle de modo para LED1 -->
        <div class="mode-control">          
          <div id="relogio" class="clock">00:00:00</div>
          <h3>Controle Programado</h3>
          <button class="mode-button auto" id="led1ModeButton">Modo Automático</button>
          
          <div class="scheduling">
            <h4 class="Agendamento">Agendamento</h4>
            <div class="time-inputs">
              <div class="time-input">
                <label for="ligarHorario">Ligar às:</label>
                <input type="time" id="ligarHorario" name="ligarHorario">
              </div>
              <div class="time-input">
                <label for="desligarHorario">Desligar às:</label>
                <input type="time" id="desligarHorario" name="desligarHorario">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Status da Bomba -->
        <div class="pump-status desligada" id="pumpStatus">
          <h3>Status da Bomba</h3>
          <div class="pump-status-content">
            <span class="pump-indicator" id="pumpIndicator"></span>
            <span id="pumpText">Desligada</span>
          </div>
        </div>
        
        <div class="led-controls">
          <h3>Controle de RELÉS</h3>
          <div class="led-buttons">
            <button class="led-button led1" id="led1Button">
              LED 1
              <span class="led-indicator" id="led1Indicator"></span>
            </button>
            <button class="led-button rele" id="releButton">
              LED 2
              <span class="led-indicator" id="releIndicator"></span>
            </button>
            <button class="led-button led3" id="led3Button">
              LED 3
              <span class="led-indicator" id="led3Indicator"></span>
            </button>
            <button class="led-button led4" id="led4Button">
              LED 4
              <span class="led-indicator" id="led4Indicator"></span>
            </button>
            <button class="led-button led5" id="led5Button">
              LED 5
              <span class="led-indicator" id="led5Indicator"></span>
            </button>
            <button class="led-button led6" id="led6Button">
              LED 6
              <span class="led-indicator" id="led6Indicator"></span>
            </button>
          </div>
        </div>
        
        <div class="voice-control">
          <h3>Controle por Voz</h3>
          <button class="voice-button" id="voiceButton">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15C13.6569 15 15 13.6569 15 12V5C15 3.34315 13.6569 2 12 2C10.3431 2 9 3.34315 9 5V12C9 13.6569 10.3431 15 12 15Z" stroke="white" stroke-width="2"/>
              <path d="M19 12C19 14.2091 17.2091 16 15 16" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M5 12C5 14.2091 6.79086 16 9 16" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 19C8 19 9.5 20 12 20C14.5 20 16 19 16 19" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 20V22" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="voice-status" id="voiceStatus">Clique para falar</div>
          <div class="voice-commands">
            Comandos: "Ligar LED 1", "Desligar LED 2", "Ligar/Desligar bomba", "Modo automático/manual"
          </div>
        </div>
        
        <div class="status-container">
          <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="connectionStatus">Conectando...</span>
          </div>
          <div class="last-update" id="lastUpdate">--:--:--</div>
        </div>
        <div class="visit-counter" id="visitCounter">Carregando...</div>
        
        <!-- Painel de debug para verificar os comandos -->
        <div class="debug-panel">
          <div class="debug-title">Debug - Comandos Reconhecidos:</div>
          <div class="debug-log" id="debugLog"></div>
        </div>
        
        <!-- Tutorial de comandos de voz -->
        <div class="voice-tutorial">
          <h3>Comandos de Voz Disponíveis</h3>
          <div class="command-list">
            <div class="command-item">
              <div class="command-action">Ligar/Desligar Bomba</div>
              <div class="command-examples">"Ligar bomba", "Desligar bomba"</div>
            </div>
            <div class="command-item">
              <div class="command-action">Controle de LEDs</div>
              <div class="command-examples">"Ligar LED 1", "Desligar LED 2"</div>
            </div>
            <div class="command-item">
              <div class="command-action">Modo de Operação</div>
              <div class="command-examples">"Modo automático", "Modo manual"</div>
            </div>
            <div class="command-item">
              <div class="command-action">Controle de Áudio</div>
              <div class="command-examples">"Ativar áudio", "Desativar áudio"</div>
            </div>
          </div>
          <button class="training-button" id="trainingButton">Treinar Reconhecimento de Voz</button>
        </div>
       <button class="logout-btn" id="logoutBtn">Sair do Sistema</button>

      </div>
    </div>
  </div>
Alerta
  <!-- Novo elemento para feedback visual -->
  <div class="command-feedback" id="commandFeedback"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // =========================
      // CONFIGURAÇÃO FIREBASE (substitua com suas credenciais)
      // =========================
      const firebaseConfig = {
        // SUAS CONFIGURAÇÕES DO FIREBASE AQUI
                    	  	apiKey: "AIzaSyBTCmlsVHFVqsdtgjT31rohV07kpcYbP4o",
  authDomain: "teste-91a58.firebaseapp.com",
  databaseURL: "https://teste-91a58-default-rtdb.firebaseio.com",
  projectId: "teste-91a58",
  storageBucket: "teste-91a58.firebasestorage.app",
  messagingSenderId: "992341314783",
  appId: "1:992341314783:web:fdd6eae1645bcf6e846d6a",
  measurementId: "G-E5F4982G9Y"
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      } else {
        firebase.app();
      }

      const database = firebase.database();
      const auth = firebase.auth();

      // =========================
      // VERIFICAÇÃO DE AUTENTICAÇÃO
      // =========================
      auth.onAuthStateChanged((user) => {
        if (!user) {
          // Usuário não está logado, redirecionar para página de login
          window.location.href = "index.html";
        }
        // Se o usuário estiver logado, continuar com a inicialização normal
      });

      // =========================
      // FUNÇÃO DE LOGOUT
      // =========================
      const logoutBtn = document.getElementById('logoutBtn');

      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          firebase.auth().signOut().then(() => {
            console.log("Usuário saiu com sucesso.");
            // Redirecionar para a página de login
            window.location.href = "index.html"; 
          }).catch((error) => {
            console.error("Erro ao sair:", error);
            showCommandFeedback('Erro ao sair do sistema', false);
          });
        });
      }

      // =========================
      // ELEMENTOS DO DOM
      // =========================
      const waterCanvas = document.getElementById('waterCanvas');
      const waterLevel = document.getElementById('waterLevel');
      const waterSummary = document.getElementById('waterSummary');
      const volumeEl = document.getElementById('volume');
      const levelEl = document.getElementById('level');
      const statusDot = document.getElementById('statusDot');
      const connectionStatus = document.getElementById('connectionStatus');
      const lastUpdate = document.getElementById('lastUpdate');
      const audioToggle = document.getElementById('audioToggle');
      const visitCounter = document.getElementById('visitCounter');
      const debugLog = document.getElementById('debugLog');
      const commandFeedback = document.getElementById('commandFeedback');

      const led1ModeButton = document.getElementById('led1ModeButton');
      const ligarHorarioInput = document.getElementById('ligarHorario');
      const desligarHorarioInput = document.getElementById('desligarHorario');

      const led1Button = document.getElementById('led1Button');
      const releButton = document.getElementById('releButton');
      const led3Button = document.getElementById('led3Button');
      const led4Button = document.getElementById('led4Button');
      const led5Button = document.getElementById('led5Button');
      const led6Button = document.getElementById('led6Button');

      const led1Indicator = document.getElementById('led1Indicator');
      const releIndicator = document.getElementById('releIndicator');
      const led3Indicator = document.getElementById('led3Indicator');
      const led4Indicator = document.getElementById('led4Indicator');
      const led5Indicator = document.getElementById('led5Indicator');
      const led6Indicator = document.getElementById('led6Indicator');

      const voiceButton = document.getElementById('voiceButton');
      const voiceStatus = document.getElementById('voiceStatus');
      const trainingButton = document.getElementById('trainingButton');

      const pumpStatus = document.getElementById('pumpStatus');
      const pumpIndicator = document.getElementById('pumpIndicator');
      const pumpText = document.getElementById('pumpText');

      // =========================
      // VARIÁVEIS DE ESTADO
      // =========================
      const ctx = waterCanvas ? waterCanvas.getContext('2d') : null;
      let canvasWidth = waterCanvas ? waterCanvas.parentElement.clientWidth : 400;
      let canvasHeight = waterCanvas ? waterCanvas.parentElement.clientHeight : 200;
      if (waterCanvas) {
        waterCanvas.width = canvasWidth;
        waterCanvas.height = canvasHeight;
      }

      let TANK_MAX_LITROS = 445;
      let waterLevelTarget = 0.0;
      let waterLevelCurrent = 0.0;
      let time = 0;
      let bubbles = [];

      let led1State = 1;
      let releState = 1;
      let led3State = 1;
      let led4State = 1;
      let led5State = 1;
      let led6State = 1;

      let pumpState = 1; // 1 = desligada, 0 = ligada
      let lastStatusUpdate = 0;
      let audioEnabled = true;
      let alertAudio = new Audio('audio/Alerta.mp3');
	   let clickAudio = new Audio('audio/click.mp3');
      let isAlertPlaying = false;
      let visitCount = 0;

      // led1Mode: 0 = Manual, 2 = Automático
      let led1Mode = 2;

      // Agendamento
      let ligarHorario = null;
      let desligarHorario = null;

      // Para evitar gravações repetidas a cada intervalo:
      const lastAutoAction = { on: null, off: null, intervalActive: null };

      // Cores da água
      const waterColors = {
        normal: { top: 'rgba(40, 209, 239, 0.85)', bottom: 'rgba(3, 105, 161, 0.95)' },
        warning: { top: 'rgba(250, 204, 21, 0.85)', bottom: 'rgba(202, 138, 4, 0.95)' },
        danger: { top: 'rgba(239, 68, 68, 0.85)', bottom: 'rgba(185, 28, 28, 0.95)' }
      };

      // =========================
      // FUNÇÃO DE DEBUG
      // =========================
      function addDebugMessage(message) {
        if (!debugLog) return;
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${timestamp}] ${message}`;
        debugLog.appendChild(logEntry);
        
        // Manter apenas as últimas 10 mensagens
        while (debugLog.children.length > 10) {
          debugLog.removeChild(debugLog.firstChild);
        }
        
        // Rolagem automática para a mensagem mais recente
        debugLog.scrollTop = debugLog.scrollHeight;
      }

      // =========================
      // FUNÇÃO PARA FEEDBACK VISUAL
      // =========================
      function showCommandFeedback(message, isSuccess = true) {
        if (!commandFeedback) return;
        
        commandFeedback.textContent = message;
        commandFeedback.style.backgroundColor = isSuccess 
          ? 'rgba(40, 167, 69, 0.9)' 
          : 'rgba(220, 53, 69, 0.9)';
        commandFeedback.classList.add('show');
        
        setTimeout(() => {
          commandFeedback.classList.remove('show');
        }, 3000);
      }

      // =========================
      // UTILITÁRIOS DE TEMPO
      // =========================
      function pad(n){ return n < 10 ? '0' + n : '' + n; }
      function formatHM(date) { return pad(date.getHours()) + ':' + pad(date.getMinutes()); }
      function timeStrToMinutes(hm) {
        const parts = hm.split(':');
        if (parts.length !== 2) return null;
        const hh = parseInt(parts[0], 10), mm = parseInt(parts[1], 10);
        if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
        return hh * 60 + mm;
      }
      function isNowInInterval(nowMin, startMin, endMin) {
        if (startMin <= endMin) {
          return nowMin >= startMin && nowMin <= endMin;
        } else {
          // intervalo atravessa meia-noite (ex: 23:00-02:00)
          return nowMin >= startMin || nowMin <= endMin;
        }
      }

      // =========================
      // VISIT COUNTER (transação)
      // =========================
      function updateVisitCounter() {
        try {
          const visitsRef = database.ref('/visits');
          visitsRef.transaction(function(currentVisits) {
            return (currentVisits || 0) + 1;
          }, function(error, committed, snapshot) {
            if (error) {
              console.error('Erro ao atualizar contador de visitas:', error);
              if (visitCounter) visitCounter.textContent = 'Erro ao carregar';
            } else if (committed) {
              visitCount = snapshot.val();
              if (visitCounter) visitCounter.textContent = `${visitCount} ${visitCount === 1 ? 'visita' : 'visitas'}`;
            }
          });

          visitsRef.on('value', (snapshot) => {
            const count = snapshot.val();
            if (count !== null) {
              visitCount = count;
              if (visitCounter) visitCounter.textContent = `${visitCount} ${visitCount === 1 ? 'visita' : 'visitas'}`;
            }
          }, (error) => {
            console.error('Erro ao ler contador de visitas:', error);
          });
        } catch (err) {
          console.error('updateVisitCounter exception:', err);
        }
      }

      // =========================
      // ATUALIZAÇÃO MODO LED1
      // =========================
      function updateLED1Mode(mode) {
        led1Mode = mode;
        if (led1ModeButton) {
          if (mode === 2) {
            led1ModeButton.textContent = 'Modo Automático';
            led1ModeButton.className = 'mode-button auto';
          } else {
            led1ModeButton.textContent = 'Modo Manual';
            led1ModeButton.className = 'mode-button manual';
          }
        }
        // Visual: desabilita o botão manual do Led1 quando automático
        if (led1Button) {
          led1Button.disabled = (mode === 2);
          led1Button.style.opacity = (mode === 2) ? '0.5' : '1';
        }
        // Atualizar no Firebase (se necessário)
        database.ref('/led1Mode').set(mode).catch(err => console.warn('Erro set led1Mode:', err));
      }

      function toggleLED1Mode() {
        updateLED1Mode(led1Mode === 2 ? 0 : 2);
      }

      // =========================
      // FUNÇÕES DO TANQUE (canvas)
      // =========================
      function drawTank() {
        if (!ctx || !waterCanvas) return;
        const W = waterCanvas.width;
        const H = waterCanvas.height;
        ctx.clearRect(0, 0, W, H);

        const waterTop = H - (H * waterLevelCurrent);

        let colors;
        if (waterLevelCurrent <= 0.05) colors = waterColors.danger;
        else if (waterLevelCurrent <= 0.2) colors = waterColors.warning;
        else colors = waterColors.normal;

        ctx.save();
        const grad = ctx.createLinearGradient(0, waterTop, 0, H);
        grad.addColorStop(0, colors.top);
        grad.addColorStop(1, colors.bottom);
        ctx.fillStyle = grad;

        ctx.beginPath();
        ctx.moveTo(0, H);
        for (let x = 0; x <= W; x += 2) {
          const y = waterTop
            + Math.sin((x * 0.04) + time * 0.08) * 8
            + Math.cos((x * 0.02) + time * 0.05) * 5
            + Math.sin((x * 0.09) + time * 0.02) * 3;
          ctx.lineTo(x, y);
        }
        ctx.lineTo(W, H);
        ctx.closePath();
        ctx.fill();
        ctx.restore();

        for (let i = bubbles.length - 1; i >= 0; i--) {
          const b = bubbles[i];
          ctx.beginPath();
          ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
          ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
          ctx.fill();
          b.y -= b.speed;
          if (b.y < waterTop) bubbles.splice(i, 1);
        }
      }

      function createBubble() {
        if (!waterCanvas) return;
        const W = waterCanvas.width;
        const H = waterCanvas.height;
        bubbles.push({
          x: Math.random() * (W - 80) + 40,
          y: H - 20,
          radius: Math.random() * 5 + 2,
          speed: Math.random() * 1.5 + 0.5
        });
      }

      function animate() {
        time += 1;
        waterLevelCurrent += (waterLevelTarget - waterLevelCurrent) * 0.08;
        if (Math.random() < 0.05) createBubble();
        drawTank();
        requestAnimationFrame(animate);
      }

      // =========================
      // ÁUDIO ALERTA
      // =========================
      function playAlert() {
        if (!audioEnabled || isAlertPlaying) return;
        isAlertPlaying = true;
        alertAudio.loop = true;
        alertAudio.play().catch(error => {
          console.log('Erro ao reproduzir áudio:', error);
          isAlertPlaying = false;
        });
      }
      function stopAlert() {
        isAlertPlaying = false;
        try {
          alertAudio.pause();
          alertAudio.currentTime = 0;
        } catch (e) { /* ignore */ }
      }
      function toggleAudio() {
        audioEnabled = !audioEnabled;
        if (audioToggle) {
          audioToggle.textContent = audioEnabled ? 'Desativar' : 'Ativar';
          audioToggle.classList.toggle('desativado', !audioEnabled);
        }
        if (!audioEnabled) stopAlert();
        else if (waterLevelTarget <= 0.05) playAlert();
      }
      if (audioToggle) audioToggle.addEventListener('click', toggleAudio);

      // =========================
      // ATUALIZAÇÕES VISUAIS
      // =========================
      function updateWaterLevel(litros) {
        const percentage = Math.min(100, Math.max(0, (litros / TANK_MAX_LITROS) * 100));
        const roundedPercentage = Math.round(percentage);
        const roundedLitros = Math.round(litros);

        if (volumeEl) volumeEl.textContent = `${roundedLitros} L`;
        if (levelEl) levelEl.textContent = `${roundedPercentage}%`;
        if (waterLevel) waterLevel.textContent = `${roundedPercentage}%`;
        if (waterSummary) waterSummary.textContent = `Restante: ${roundedLitros} L de ${TANK_MAX_LITROS} L`;

        if (percentage <= 5) {
          if (waterSummary) waterSummary.className = 'danger';
          if (audioEnabled) playAlert();
        } else if (percentage <= 20) {
          if (waterSummary) waterSummary.className = 'warning';
          stopAlert();
        } else {
          if (waterSummary) waterSummary.className = 'normal';
          stopAlert();
        }

        waterLevelTarget = percentage / 100;
        if (lastUpdate) lastUpdate.textContent = new Date().toLocaleTimeString();
      }

      function updatePumpStatus(state) {
        pumpState = state;
        const isOn = state === 0;
        if (pumpStatus) {
          pumpStatus.classList.toggle('ligada', isOn);
          pumpStatus.classList.toggle('desligada', !isOn);
        }
        if (pumpText) pumpText.textContent = isOn ? 'Ligada' : 'Desligada';
      }

      // =========================
      // LISTENERS FIREBASE (caixa, Status, bomba, leds)
      // =========================
      function setupLEDListeners() {
        // Helper to attach generic led listeners
        function attachLed(refName, buttonEl, indicatorEl, stateVarSetter) {
          database.ref(refName).on('value', (snapshot) => {
            const state = snapshot.val();
            const isOn = state === 0;
            if (buttonEl) buttonEl.classList.toggle('ligado', isOn);
            if (indicatorEl) indicatorEl.classList.toggle('ligado', isOn);
            stateVarSetter(state);
          }, (err) => console.error('Erro ler', refName, err));
        }

        attachLed('/led1', led1Button, led1Indicator, (s) => { led1State = s; });
        attachLed('/rele', releButton, releIndicator, (s) => { releState = s; });
        attachLed('/led3', led3Button, led3Indicator, (s) => { led3State = s; });
        attachLed('/led4', led4Button, led4Indicator, (s) => { led4State = s; });
        attachLed('/led5', led5Button, led5Indicator, (s) => { led5State = s; });
        attachLed('/led6', led6Button, led6Indicator, (s) => { led6State = s; });

        // Cliques - controle manual (led1 respeita modo)
       if (led1Button) led1Button.addEventListener('click', () => {
  playClickSound(); // 🔊 toca o clique
  if (led1Mode === 0) {
    const newState = led1State === 0 ? 1 : 0;
    database.ref('/led1').set(newState).catch(err => console.error('Erro set led1:', err));
  }
});
if (releButton) releButton.addEventListener('click', () => {
  playClickSound(); // 🔊 toca o clique
  const newState = releState === 0 ? 1 : 0;
  database.ref('/rele').set(newState).catch(err => console.error('Erro set rele:', err));
});
if (led3Button) led3Button.addEventListener('click', () => {
  playClickSound(); // 🔊 toca o clique
  const newState = led3State === 0 ? 1 : 0;
  database.ref('/led3').set(newState).catch(err => console.error('Erro set led3:', err));
});
if (led4Button) led4Button.addEventListener('click', () => {
  playClickSound(); // 🔊 toca o clique
  const newState = led4State === 0 ? 1 : 0;
  database.ref('/led4').set(newState).catch(err => console.error('Erro set led4:', err));
});
if (led5Button) led5Button.addEventListener('click', () => {
  playClickSound(); // 🔊 toca o clique
  const newState = led5State === 0 ? 1 : 0;
  database.ref('/led5').set(newState).catch(err => console.error('Erro set led5:', err));
});
if (led6Button) led6Button.addEventListener('click', () => {
  playClickSound(); // 🔊 toca o clique
  const newState = led6State === 0 ? 1 : 0;
  database.ref('/led6').set(newState).catch(err => console.error('Erro set led6:', err));
});

      }

      function setupFirebaseListeners() {
        // Caixa
        database.ref('/caixa').on('value', (snapshot) => {
          const value = snapshot.val();
          if (value !== null && !isNaN(value)) {
            updateWaterLevel(Number(value));
          }
        }, (err) => {
          console.error('Erro ler /caixa:', err);
          if (connectionStatus) { connectionStatus.textContent = 'Erro de conexão'; }
          if (statusDot) { statusDot.style.background = '#ff9800'; }
        });

        // Status heartbeat
        database.ref('/Status').on('value', (snapshot) => {
          lastStatusUpdate = Date.now();
          updateConnectionStatus();
        }, (err) => console.error('Erro ler /Status:', err));

        // Bomba
        database.ref('/bomba').on('value', (snapshot) => {
          const state = snapshot.val();
          if (state !== null) updatePumpStatus(state);
        }, (err) => console.error('Erro ler /bomba:', err));

        // modo led1 (também sincroniza UI)
        database.ref('/led1Mode').on('value', (snapshot) => {
          const mode = snapshot.val();
          if (mode !== null) updateLED1Mode(mode);
        });

        // Agendamentos (sincronizar variáveis e inputs)
        database.ref('/ligarHorario').on('value', (snapshot) => {
          ligarHorario = snapshot.val();
          if (ligarHorario && ligarHorarioInput) ligarHorarioInput.value = ligarHorario;
        });
        database.ref('/desligarHorario').on('value', (snapshot) => {
          desligarHorario = snapshot.val();
          if (desligarHorario && desligarHorarioInput) desligarHorarioInput.value = desligarHorario;
        });

        // LEDs
        setupLEDListeners();
      }

      // =========================
      // SCHEDULING: listeners de inputs + lógica automática
      // =========================
      function setupSchedulingListeners() {
        if (ligarHorarioInput) {
          ligarHorarioInput.addEventListener('change', function() {
            ligarHorario = this.value && this.value.trim() !== '' ? this.value.trim() : null;
            database.ref('/ligarHorario').set(ligarHorario).catch(err => console.error('Erro set ligarHorario', err));
          });
        }
        if (desligarHorarioInput) {
          desligarHorarioInput.addEventListener('change', function() {
            desligarHorario = this.value && this.value.trim() !== '' ? this.value.trim() : null;
            database.ref('/desligarHorario').set(desligarHorario).catch(err => console.error('Erro set desligarHorario', err));
          });
        }

        if (led1ModeButton) led1ModeButton.addEventListener('click', toggleLED1Mode);
      }

      function checkAutomaticMode() {
        try {
          if (led1Mode !== 2) return; // só age no modo automático

          const now = new Date();
          const nowHM = formatHM(now);
          const nowMin = timeStrToMinutes(nowHM);

          // 1) Se encontrar intervalo no formato "HH:MM-HH:MM" em ligarHorario ou desligarHorario
          let intervalSource = null;
          let startHM = null, endHM = null;

          if (ligarHorario && ligarHorario.includes('-')) {
            intervalSource = ligarHorario;
          } else if (desligarHorario && desligarHorario.includes('-')) {
            intervalSource = desligarHorario;
          } else if (ligarHorario && desligarHorario && ligarHorario.includes(':') && desligarHorario.includes(':')) {
            // Em caso de existir separadamente ambos horários, podemos considerar intervalo (ligar = start, desligar = end)
            intervalSource = `${ligarHorario}-${desligarHorario}`;
          }

          if (intervalSource) {
            const parts = intervalSource.split('-');
            if (parts.length === 2) {
              startHM = parts[0].trim();
              endHM = parts[1].trim();
              const startMin = timeStrToMinutes(startHM);
              const endMin = timeStrToMinutes(endHM);
              if (startMin !== null && endMin !== null) {
                const active = isNowInInterval(nowMin, startMin, endMin);
                // evita escritas contínuas
                if (lastAutoAction.intervalActive === null || lastAutoAction.intervalActive !== active) {
                  lastAutoAction.intervalActive = active;
                  if (active) {
                    // ligar se estiver desligado
                    if (led1State !== 0) {
                      database.ref('/led1').set(0).then(() => {
                        console.log('LED1 ligado automaticamente (intervalo) às', nowHM);
                      }).catch(err => console.error('Erro auto ligar interval:', err));
                    }
                  } else {
                    if (led1State !== 1) {
                      database.ref('/led1').set(1).then(() => {
                        console.log('LED1 desligado automaticamente (intervalo) às', nowHM);
                      }).catch(err => console.error('Erro auto deslig interval:', err));
                    }
                  }
                }
                return; // intervalo processado
              }
            }
          }

          // 2) Sem intervalo: tratar horários exatos (ligarHorario = "HH:MM", desligarHorario="HH:MM")
          if (ligarHorario && ligarHorario.indexOf('-') === -1) {
            if (nowHM === ligarHorario && lastAutoAction.on !== ligarHorario) {
              lastAutoAction.on = ligarHorario;
              database.ref('/led1').set(0).then(() => console.log('LED1 ligado automaticamente às', nowHM))
                .catch(err => console.error('Erro auto ligar:', err));
            }
          }
          if (desligarHorario && desligarHorario.indexOf('-') === -1) {
            if (nowHM === desligarHorario && lastAutoAction.off !== desligarHorario) {
              lastAutoAction.off = desligarHorario;
              database.ref('/led1').set(1).then(() => console.log('LED1 desligado automaticamente às', nowHM))
                .catch(err => console.error('Erro auto desligar:', err));
            }
          }
        } catch (err) {
          console.error('checkAutomaticMode error:', err);
        }
      }

      // =========================
      // STATUS CONEXÃO
      // =========================
      function updateConnectionStatus() {
        const now = Date.now();
        const isConnected = (now - lastStatusUpdate) < 10000; // se houve heartbeat nos últimos 10s
        if (connectionStatus) connectionStatus.textContent = isConnected ? 'Conectado' : 'Desconectado';
        if (statusDot) statusDot.style.background = isConnected ? '#4CAF50' : '#f44336';
        if (!isConnected) document.body.classList.add('disconnected'); else document.body.classList.remove('disconnected');
      }

      // =========================
      // TREINAMENTO DE VOZ
      // =========================
      function setupVoiceTraining() {
        if (!trainingButton) return;
        
        trainingButton.addEventListener('click', () => {
          if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;
            
            recognition.onstart = function() {
              showCommandFeedback('Fale os comandos para treinamento...', true);
              addDebugMessage('Treinamento de voz iniciado');
            };
            
            recognition.onresult = function(event) {
              const transcript = event.results[0][0].transcript;
              showCommandFeedback(`Treinamento: "${transcript}"`, true);
              addDebugMessage(`Comando de treinamento: "${transcript}"`);
            };
            
            recognition.onerror = function(event) {
              showCommandFeedback(`Erro no treinamento: ${event.error}`, false);
              addDebugMessage(`Erro no treinamento: ${event.error}`);
            };
            
            recognition.onend = function() {
              showCommandFeedback('Treinamento concluído', true);
              addDebugMessage('Treinamento de voz concluído');
            };
            
            try {
              recognition.start();
            } catch (e) {
              showCommandFeedback('Erro ao iniciar treinamento', false);
              addDebugMessage('Erro ao iniciar treinamento de voz');
            }
          } else {
            showCommandFeedback('Navegador não suporta treinamento de voz', false);
            addDebugMessage('Navegador não suporta treinamento de voz');
          }
        });
      }

      // =========================
      // RECONHECIMENTO DE VOZ (corrigido e melhorado)
      // =========================
      function setupVoiceControl() {
        if (!voiceButton || !voiceStatus) return;
        let recognition = null;
        let isListening = false;
        let recognitionTimeout;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.lang = 'pt-BR';
          recognition.interimResults = false;
          recognition.maxAlternatives = 1;

          recognition.onstart = function() {
            isListening = true;
            voiceButton.classList.add('listening');
            voiceStatus.textContent = 'Ouvindo...';
            
            // Timeout automático após 5 segundos
            recognitionTimeout = setTimeout(() => {
              if (isListening) {
                recognition.stop();
                voiceStatus.textContent = 'Tempo limite atingido';
                addDebugMessage('Reconhecimento de voz: tempo limite atingido');
              }
            }, 5000);
          };

          recognition.onresult = function(event) {
            clearTimeout(recognitionTimeout);
            const command = event.results[0][0].transcript.toLowerCase();
            voiceStatus.textContent = `Reconhecido: ${command}`;
            addDebugMessage(`Comando reconhecido: "${command}"`);
            processVoiceCommand(command);
          };

          recognition.onerror = function(event) {
            clearTimeout(recognitionTimeout);
            voiceStatus.textContent = `Erro: ${event.error}`;
            addDebugMessage(`Erro no reconhecimento: ${event.error}`);
            stopListening();
          };

          recognition.onend = function() {
            clearTimeout(recognitionTimeout);
            stopListening();
          };

          function startListening() {
            if (recognition) {
              try { 
                recognition.start(); 
                addDebugMessage('Reconhecimento de voz iniciado');
              } catch (e) { 
                console.error('startListening', e); 
                voiceStatus.textContent = 'Erro ao iniciar. Tente novamente.'; 
                addDebugMessage('Erro ao iniciar reconhecimento de voz');
              }
            }
          }
          
          function stopListening() {
            isListening = false;
            voiceButton.classList.remove('listening');
          }
          
          function processVoiceCommand(command) {
            // Primeiro verifica se é um comando de DESLIGAR (correção do problema)
            if (command.includes('desligar')) {
              addDebugMessage('Processando comando DESLIGAR');
              
              if (command.includes('bomba')) {
                database.ref('/bomba').set(1).then(() => {
                  voiceStatus.textContent = 'Bomba desligada';
                  showCommandFeedback('Bomba desligada');
                  addDebugMessage('Bomba desligada por comando de voz');
                });
                return;
              }
              
              // Verificar LEDs
              const leds = [
                {name: '1', ref: '/led1'}, {name: '2', ref: '/rele'}, 
                {name: '3', ref: '/led3'}, {name: '4', ref: '/led4'},
                {name: '5', ref: '/led5'}, {name: '6', ref: '/led6'}
              ];
              
              for (const led of leds) {
                if (command.includes(led.name) || 
                    (led.name === '1' && (command.includes('um') || command.includes('1'))) ||
                    (led.name === '2' && (command.includes('dois') || command.includes('2'))) ||
                    (led.name === '3' && (command.includes('três') || command.includes('3'))) ||
                    (led.name === '4' && (command.includes('quatro') || command.includes('4'))) ||
                    (led.name === '5' && (command.includes('cinco') || command.includes('5'))) ||
                    (led.name === '6' && (command.includes('seis') || command.includes('6')))) {
                  
                  database.ref(led.ref).set(1).then(() => {
                    voiceStatus.textContent = `LED ${led.name} desligado`;
                    showCommandFeedback(`LED ${led.name} desligado`);
                    addDebugMessage(`LED ${led.name} desligado por comando de voz`);
                  });
                  return;
                }
              }
              
              // Comando genérico de desligar tudo
              if (command.includes('tudo')) {
                database.ref('/bomba').set(1);
                for (let i = 1; i <= 6; i++) {
                  database.ref(i === 2 ? '/rele' : `/led${i}`).set(1);
                }
                voiceStatus.textContent = 'Tudo desligado';
                showCommandFeedback('Todos os dispositivos desligados');
                addDebugMessage('Todos os dispositivos desligados por comando de voz');
                return;
              }
            }
            
            // Depois verifica se é um comando de LIGAR
            if (command.includes('ligar')) {
              addDebugMessage('Processando comando LIGAR');
              
              if (command.includes('bomba')) {
                database.ref('/bomba').set(0).then(() => {
                  voiceStatus.textContent = 'Bomba ligada';
                  showCommandFeedback('Bomba ligada');
                  addDebugMessage('Bomba ligada por comando de voz');
                });
                return;
              }
              
              // Verificar LEDs
              const leds = [
                {name: '1', ref: '/led1'}, {name: '2', ref: '/rele'}, 
                {name: '3', ref: '/led3'}, {name: '4', ref: '/led4'},
                {name: '5', ref: '/led5'}, {name: '6', ref: '/led6'}
              ];
              
              for (const led of leds) {
                if (command.includes(led.name) || 
                    (led.name === '1' && (command.includes('um') || command.includes('1'))) ||
                    (led.name === '2' && (command.includes('dois') || command.includes('2'))) ||
                    (led.name === '3' && (command.includes('três') || command.includes('3'))) ||
                    (led.name === '4' && (command.includes('quatro') || command.includes('4'))) ||
                    (led.name === '5' && (command.includes('cinco') || command.includes('5'))) ||
                    (led.name === '6' && (command.includes('seis') || command.includes('6')))) {
                  
                  // Para o LED 1, verificar se está no modo manual
                  if (led.name === '1' && led1Mode === 2) {
                    voiceStatus.textContent = 'LED 1 está no modo automático';
                    showCommandFeedback('LED 1 está no modo automático', false);
                    addDebugMessage('Tentativa de ligar LED 1 no modo automático bloqueada');
                    return;
                  }
                  
                  database.ref(led.ref).set(0).then(() => {
                    voiceStatus.textContent = `LED ${led.name} ligado`;
                    showCommandFeedback(`LED ${led.name} ligado`);
                    addDebugMessage(`LED ${led.name} ligado por comando de voz`);
                  });
                  return;
                }
              }
              
              // Comando genérico de ligar tudo
              if (command.includes('tudo')) {
                database.ref('/bomba').set(0);
                for (let i = 1; i <= 6; i++) {
                  // Para o LED 1, verificar se está no modo manual
                  if (i === 1 && led1Mode === 2) {
                    continue; // Pular LED 1 se estiver no modo automático
                  }
                  database.ref(i === 2 ? '/rele' : `/led${i}`).set(0);
                }
                voiceStatus.textContent = 'Tudo ligado';
                showCommandFeedback('Todos os dispositivos ligados');
                addDebugMessage('Todos os dispositivos ligados por comando de voz (exceto LED 1 se automático)');
                return;
              }
            }
            
            // Modos de operação
            if (command.includes('modo automático') || command.includes('automático')) {
              updateLED1Mode(2); 
              voiceStatus.textContent = 'Modo automático ativado'; 
              showCommandFeedback('Modo automático ativado');
              addDebugMessage('Modo automático ativado por comando de voz');
              return;
            }
            if (command.includes('modo manual') || command.includes('manual')) {
              updateLED1Mode(0); 
              voiceStatus.textContent = 'Modo manual ativado'; 
              showCommandFeedback('Modo manual ativado');
              addDebugMessage('Modo manual ativado por comando de voz');
              return;
            }
            
            // Controle de áudio
            if (command.includes('áudio') || command.includes('som') || command.includes('alerta')) {
              if (command.includes('desligar') || command.includes('desativar')) {
                audioEnabled = false;
                audioToggle.textContent = 'Ativar';
                audioToggle.classList.add('desativado');
                stopAlert();
                voiceStatus.textContent = 'Áudio desativado';
                showCommandFeedback('Áudio desativado');
                addDebugMessage('Áudio desativado por comando de voz');
              } else if (command.includes('ligar') || command.includes('ativar')) {
                audioEnabled = true;
                audioToggle.textContent = 'Desativar';
                audioToggle.classList.remove('desativado');
                voiceStatus.textContent = 'Áudio ativado';
                showCommandFeedback('Áudio ativado');
                addDebugMessage('Áudio ativado por comando de voz');
              }
              return;
            }
            
            // Comando de ajuda
            if (command.includes('ajuda') || command.includes('comandos')) {
              voiceStatus.textContent = 'Comandos: "Ligar/Desligar bomba", "Ligar/Desligar LED [1-6]", "Modo automático/manual"';
              showCommandFeedback('Lista de comandos exibida');
              addDebugMessage('Solicitada ajuda de comandos por voz');
              return;
            }
            
            voiceStatus.textContent = 'Comando não reconhecido. Diga "ajuda" para ver os comandos.';
            showCommandFeedback('Comando não reconhecido', false);
            addDebugMessage('Comando de voz não reconhecido: ' + command);
          }

          voiceButton.addEventListener('click', () => {
            if (isListening) {
              recognition.stop();
              addDebugMessage('Reconhecimento de voz interrompido pelo usuário');
            } else {
              voiceStatus.textContent = 'Preparando...';
              setTimeout(startListening, 300); // Pequeno delay para melhor UX
            }
          });

        } else {
          voiceStatus.textContent = 'Navegador não suporta reconhecimento de voz';
          addDebugMessage('Navegador não suporta reconhecimento de voz');
          if (voiceButton) voiceButton.disabled = true;
        }
      }
        // =========================
      // INICIALIZAÇÃO
      // =========================
      function init() {
        addDebugMessage('Sistema iniciado');
        updateVisitCounter();
        setupFirebaseListeners();
        setupSchedulingListeners();
        setupVoiceControl();
        setupVoiceTraining();

        // Start canvas animation
        animate();

        // Intervals
        setInterval(updateConnectionStatus, 2000);
        // checagem automática a cada 30s (pode ajustar)
        setInterval(checkAutomaticMode, 30000);

        // Resize handling
        window.addEventListener('resize', () => {
          if (!waterCanvas) return;
          canvasWidth = waterCanvas.parentElement.clientWidth;
          canvasHeight = waterCanvas.parentElement.clientHeight;
          waterCanvas.width = canvasWidth;
          waterCanvas.height = canvasHeight;
          drawTank();
        });
      }

// =========================
      // FUNÇÃO PARA TOCAR SOM DE CLIQUE - NOVA FUNÇÃO
      // =========================
      function playClickSound() {
        if (!audioEnabled) return;
        
        try {
          // Reiniciar e tocar o som de clique
          clickAudio.currentTime = 0;
          clickAudio.play().catch(error => {
            console.log('Erro ao reproduzir som de clique:', error);
          });
        } catch (e) {
          console.log('Erro no som de clique:', e);
        }
      }

      // Relógio em tempo real
      function atualizarRelogio() {
        const agora = new Date();
        const h = String(agora.getHours()).padStart(2,'0');
        const m = String(agora.getMinutes()).padStart(2,'0');
        const s = String(agora.getSeconds()).padStart(2,'0');
        document.getElementById("relogio").innerText = `${h}:${m}:${s}`;
      }
	  
	  
      setInterval(atualizarRelogio, 1000);
      atualizarRelogio();
      function init() {
        // Verificar se o usuário está autenticado antes de inicializar
        const user = auth.currentUser;
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        addDebugMessage('Sistema iniciado');
        updateVisitCounter();
        setupFirebaseListeners();
        setupSchedulingListeners();
        setupVoiceControl();
        setupVoiceTraining();

        // Start canvas animation
        animate();

        // Intervals
        setInterval(updateConnectionStatus, 2000);
        setInterval(checkAutomaticMode, 30000);

        // Resize handling
        window.addEventListener('resize', () => {
          if (!waterCanvas) return;
          canvasWidth = waterCanvas.parentElement.clientWidth;
          canvasHeight = waterCanvas.parentElement.clientHeight;
          waterCanvas.width = canvasWidth;
          waterCanvas.height = canvasHeight;
          drawTank();
        });
      }

      // ... (restante das suas funções existentes)

      // Executa init apenas se o usuário estiver autenticado
      auth.onAuthStateChanged((user) => {
        if (user) {
          init();
        }
      });
    });
  </script>
</body>
</html>
